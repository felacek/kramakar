<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Bozi matematicka soutez</title>
  <script>
      let user = "";
      let token = "";
      let objFetch = {};
      const HOST = window.location.protocol + "//" + window.location.hostname + ((window.location.port) ? ":" + window.location.port : "");
      let player = {name: "host", token: "1", owns: {obj: {id:3, number: 1000, type: "factory"}}, buy: {}, sell: {}};
      //Zpet
      let backOnMainPage = '<br> <input type = "button" onclick = "loadMainPage()" value="Zpet na hlavni vyber ">';
      // zobrazitelne stranky
      // Prihlaseni
      let logPage = '<h1> Vítej na naší stránce </h1><br>';
      logPage = logPage + '<h2>Prihlaseni</h2>';
      logPage = logPage + '<br><input type= "text" id = "nickname" value = "Nickname"></br>';
      logPage = logPage + '<br><input type= "text" id = "password" value = "Password"></br>';
      logPage = logPage + '<br><input type= "button" onclick="logIn()" value="Prihlas se"></br>';
      logPage = logPage + '<h3><input type = "button" onclick="loadRegisterPage()" value = "Nejsem za registrovan "> </h3>';
      // Registrace
      let registerPage = '<h1>REGISTRACE</h1>';
      registerPage = registerPage + '<br><input type= "text" id = "nickname" value="Nickname"</br>';
      registerPage = registerPage + '<br><input type= "text" id = "passwordx" value = "Password"></br>';
      registerPage = registerPage + '<br><input type= "text" id = "passwordy" value = "Repeat password"></br>';
      registerPage = registerPage + '<br><input type= "text" id = "mail" value="Mail"></br>';
      registerPage = registerPage + '<h3><input type = "button" onclick="registerNewUser()" value="Registrace"> </h3>';
      registerPage = registerPage + '<h3><input type = "button" onclick="loadLogPage()" value="Vratit se k prihlaseni"> </h3>';


      // Main page
      let mainPage = '<h1>Prihlasen <a id = "userMainPage"></a></h1>';
      mainPage = mainPage + '<br><input type = "button" onclick="loadMarketPage()" value="Market">';
      mainPage = mainPage + '<br><input type = "button" onclick="loadQuestPage()" value="Ulohy">';
      mainPage = mainPage + '<br><input type = "button" onclick="loadResultsPage()" value="Vysledovka">';
      mainPage = mainPage + '<br><input type = "button" onclick="logOut()" value="Odhlasit se">';
      // Zadání
      let questPage = '<h1>Zadani bozich uloh </h1>';
      questPage = questPage + '<div id="quest"></div>';
      questPage = questPage + backOnMainPage;
      //Vysledovka
      let resultsPage = '<h1>Poradi</h1>';
      resultsPage = resultsPage + backOnMainPage;
      //Market
      let marketPage = '<h1>Market</h1>';
      marketPage = marketPage + '<div id="mainTableMarket"></div>';
      marketPage = marketPage + '<input type = "button" id = "zmenitObjednavku" onclick = "zmenObjednavku()">';
      marketPage = marketPage + backOnMainPage;

      // Funkce
      function loadMarketPage() {
          document.getElementById("page").innerHTML = marketPage;
          // nacte stranku
          loadMainTableMarket();
          // nacte tabulku
      }

      function loadQuestPage() {
          document.getElementById("page").innerHTML = questPage
      }

      function loadResultsPage() {
          document.getElementById("page").innerHTML = resultsPage
      }

      function loadAll() {
          loadLogPage()
      }
      function zmenObjednavku (){
          console.log(document.getElementById('3').value);
          document.getElementById('3divMainMarketTableNakup').innerHTML = document.getElementById('3').value;
      }
      function loadMainTableMarket() {
          //let obj = fetchPost (0,'/mainTableMarket');
          let obj = {};
          obj.coal = {id: '3', name: 'sur3', price: '10000000', buyable: false};
          let s = `<table style="width:100%"> <tr> <th> Surovina</th> <th> Cena na trhu </th> <th> Sklad </th> <th>Nakup</th> <th>Zmena nakupu</th> </tr>`;
          for (o of Object.keys(obj)){
              let k = obj[o];
              s += `<tr> <th>` + k.name + `</a></span></th><th>` + k.price + `</th> <th><div>Loading</div></th> <th><div id ='`+ k.id +`divMainMarketTableNakup` +`'></div></th> <th><input type = 'text' id ='` + k.id + `'></th></tr>`;
          }
          s += `</table>`;
          document.getElementById("mainTableMarket").innerHTML = s
      }


      function loadLogPage() {
          document.getElementById("page").innerHTML = logPage
      }

      function logIn() {
          let body = {};
          body.name = document.getElementById("nickname").value;
          body.passwd = document.getElementById("password").value;
          if (body.name === "host") {
              user = "host";
              token = "host1"

          } else {
              let obj = fetchPost(body, '/logIn');
              let waittime = 0;
              while (obj === 'undefined') {
                  console.log("Registrace zapocata");
                  console.log(waittime);
                  waittime++
              };
              user = obj.name;
              token = obj.token;
              player = obj.player;
          }
          if (user !== "") {
              loadMainPage()

          } else {
              alert("kamo, jsi vedle")
          }

      }

      function loadRegisterPage() {
          document.getElementById("page").innerHTML = registerPage
      }

      function registerNewUser() {
          objFetch = {};
          let body = {};
          body.name = document.getElementById("nickname").value;
          body.passwd = document.getElementById("passwordx").value;
          //if (body.passw  document.getElementById("passwordy").value;
          let url = '/registerNewUser';
          fetchPost(body, url).then(function (){
          if (obj.kod == '0') {
              alert('ouvej zkus to znova')
          } else {
              alert('jsi zaregistrovan')
          }
          objFetch={}
      })}

      function loadMainPage() {
          document.getElementById("page").innerHTML = mainPage;
          document.getElementById("userMainPage").innerHTML = user;
      }

      function logOut() {
          user = '';
          let tokenSave = token;
          token = '0';

          document.getElementById("page").innerHTML = logPage;
          alert("vrat se brzy");
          let body = {};
          body.token = tokenSave;
          fetchPost(body,'/logout');
          token = '0';
      }


      // Fetche
      // fetchPost resi postovani
      function fetchPost(body, url) {
          url = HOST + url ;
          let options = {};
          options.method = "POST";
          options.body = JSON.stringify(body);
          fetch(url, options).then(function (response) {
              response.text().then(function (text) {
                  objFetch = JSON.parse(text);
              })
          })
      }
  </script>
</head>
<body onload="loadAll()">
<div id="page"></div>
</body>
</html>
